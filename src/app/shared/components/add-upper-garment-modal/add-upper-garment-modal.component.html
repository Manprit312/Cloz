<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-title class="ion-text-center">Add upper garment.</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="close()" fill="clear" class="body1-regular">
        Close
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="add-garment-content">
  <div class="pad-top-lg pad-v-none-h-md column-stack-none add-garment-wrapper">
    <!-- Error Banner -->
    <div class="error-banner pad-all-md row-stack-sm items-center" *ngIf="showErrorMessage">
      <app-icon name="close" [size]="24" [color]="'#ffffff'"></app-icon>
      <span class="body1-medium">{{ errorMessageText }}</span>
    </div>

    <!-- Image Upload Section -->
    <div class="column-stack-sm image-section">
      <label class="label-default">Choose image</label>
      <div class="image-upload-container column-stack-md items-center">
        <input
          type="file"
          accept="image/*"
          (change)="onImageSelected($event)"
          class="file-input"
          id="image-upload-input"
        />
        <div class="image-upload-area column-stack-none items-center justify-center" (click)="triggerFileInput()">
          <!-- Compression Loading Overlay -->
          <div *ngIf="isCompressing" class="compression-overlay">
            <ion-spinner name="crescent" color="primary"></ion-spinner>
            <p class="compression-text body1-medium">Compressing image...</p>
          </div>
          
          <!-- Success Indicator -->
          <div *ngIf="compressionSuccess && !isCompressing" class="compression-success">
            <app-icon name="checkmark-circle" [size]="24" [color]="'#4CAF50'"></app-icon>
            <p class="success-text body2-medium">Image optimized!</p>
          </div>
          
          <div *ngIf="!imageUrl && !isCompressing" class="image-placeholder row-stack-none items-center justify-center">
            <app-icon name="image" [size]="48" [color]="'var(--text-color-600, #666666)'"></app-icon>
          </div>
          <div *ngIf="imageUrl && !isCompressing" class="image-with-button column-stack-none items-center justify-center">
            <img [src]="imageUrl" alt="Garment" class="garment-image" />
        <app-button
          variant="tertiary"
          size="medium"
          [fullWidth]="false"
              (click)="triggerFileInput(); $event.stopPropagation()"
              class="replace-button-inside"
        >
          <app-icon name="refresh" [size]="20" [color]="'var(--ion-color-primary)'" class="mr-sm"></app-icon>
          Replace
        </app-button>
          </div>
        </div>
        <p *ngIf="!imageUrl" class="image-instruction body1-regular text-color-600">Add a photo of your garment</p>
        <app-button
          *ngIf="!imageUrl"
          variant="primary"
          size="medium"
          [fullWidth]="false"
          (click)="triggerFileInput()"
          class="upload-button"
        >
          Upload image
          <app-icon name="add" [size]="20" [color]="'var(--ion-color-primary-contrast)'" class="ml-sm"></app-icon>
        </app-button>
      </div>
    </div>

    <!-- Form Fields -->
    <div class="column-stack-lg">
      <!-- Subtype -->
      <div class="column-stack-sm">
        <div class="input-border-full select-field row-stack-none items-center justify-between" (click)="openSubtypeSelection()">
          <span class="label-default">Subtype</span>
          <div class="row-stack-xs items-center">
            <span [class.text-placeholder]="!subtype" class="body1-regular value-text ion-text-end">
              {{ subtype || 'Select subtype' }}
            </span>
            <app-icon name="chevron-forward" [size]="20" [color]="'var(--text-color-600)'"></app-icon>
          </div>
        </div>
      </div>

      <!-- Color -->
      <div class="column-stack-sm">
        <div class="input-border-full select-field row-stack-none items-center justify-between" (click)="openColorSelection()">
          <span class="label-default">Color</span>
          <div class="row-stack-xs items-center">
            <span [class.text-placeholder]="!color" class="body1-regular value-text ion-text-end">
              {{ color || 'Select color' }}
            </span>
            <app-icon name="chevron-forward" [size]="20" [color]="'var(--text-color-600)'"></app-icon>
          </div>
        </div>
      </div>

      <!-- Brand -->
      <div class="column-stack-sm">
        <label class="label-default">Brand</label>
        <div class="input-border-full">
          <input
            #brandInput
            type="text"
            [(ngModel)]="brand"
            placeholder="Name brand"
            class="body1-regular"
            enterkeyhint="done"
            (keydown.enter)="brandInput.blur(); dismissKeyboard()"
            (blur)="dismissKeyboard()"
          />
        </div>
        <span class="text-color-600 body2-regular optional-text">Optional</span>
      </div>
    </div>

    <!-- Add Button -->
    <div class="button-container">
      <app-button
        variant="primary"
        size="xlarge"
        [fullWidth]="true"
        [disabled]="!isFormValid"
        (click)="addToWardrobe()"
      >
        Add to wardrobe
      </app-button>
    </div>
  </div>
</ion-content>

