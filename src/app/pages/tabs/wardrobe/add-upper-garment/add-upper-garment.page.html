<ion-backdrop *ngIf="isModalOpen" [visible]="true" [tappable]="false"></ion-backdrop>

<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-title class="ion-text-center">{{ isEditMode ? 'Update upper garment' : 'Add upper garment' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="close()" fill="clear" class="body1-regular">
        Close
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content #content [fullscreen]="true" class="add-garment-content">
  <div class="pad-top-lg pad-v-none-h-md add-garment-wrapper">
    <!-- Error Banner -->
    <div class="row-stack-sm items-center error-banner pad-all-md" *ngIf="showErrorMessage">
      <app-icon name="close" [size]="24" [color]="'var(--ion-color-primary-contrast)'"></app-icon>
      <span class="body1-medium">{{ errorMessageText }}</span>
    </div>

    <!-- Image Upload Section -->
    <div class="column-stack-sm image-section">
      <label class="label-default">Choose image</label>
      <div class="column-stack-md items-center image-upload-container">
        <input
          type="file"
          accept="image/*"
          (change)="onImageSelected($event)"
          class="file-input"
          id="image-upload-input"
        />

        <div class="column-stack-none items-center justify-center image-upload-area" (click)="triggerFileInput()">
          <!-- Compression Loading Overlay -->
          <div *ngIf="isCompressing" class="column-stack-none items-center justify-center w-full h-full compression-overlay">
            <ion-spinner name="crescent" color="primary"></ion-spinner>
            <p class="compression-text body1-medium">Compressing image...</p>
          </div>
          
          <!-- Success Indicator -->
          <div *ngIf="compressionSuccess && !isCompressing" class="row-stack-xs items-center compression-success">
            <app-icon name="checkmark-circle" [size]="24" [color]="'var(--ion-color-success, #4CAF50)'"></app-icon>
            <p class="success-text body2-medium">Image optimized!</p>
          </div>
          
          <div *ngIf="!imageUrl && !isCompressing" class="column-stack-md items-center justify-center w-full h-full image-placeholder-container">
            <div class="items-center justify-center image-placeholder">
              <app-icon name="image" [size]="48" [color]="'var(--text-color-600)'"></app-icon>
            </div>
            <app-button
              variant="primary"
              size="medium"
              [fullWidth]="false"
              (click)="triggerFileInput(); $event.stopPropagation()"
              class="upload-button-inside"
            >
              Upload garment image
              <app-icon name="add" [size]="20" [color]="'var(--ion-color-primary-contrast)'" class="ml-sm"></app-icon>
            </app-button>
          </div>
          <div *ngIf="imageUrl && !isCompressing" class="column-stack-none items-center justify-center w-full h-full image-with-button">
            <img [src]="imageUrl" alt="Garment" class="garment-image" />
            <app-button
              variant="tertiary"
              size="medium"
              [fullWidth]="false"
              (click)="triggerFileInput(); $event.stopPropagation()"
              class="replace-button-inside"
            >
              <app-icon name="refresh" [size]="20" [color]="'var(--ion-color-primary)'" class="mr-sm"></app-icon>
              Replace
            </app-button>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Fields -->
    <div class="column-stack-lg">
      <!-- Subtype -->
      <div class="column-stack-sm">
        <label class="label-default">Subtype</label>
        <div class="input-border-full row-stack-none items-center justify-between select-field" (click)="openSubtypeSelection()">
          <span [class.text-placeholder]="!subtype" class="body1-regular flex-1">
            {{ subtype || 'Select subtype' }}
          </span>
          <app-icon name="unfold-more" [size]="20" [color]="'var(--text-color-600)'"></app-icon>
        </div>
      </div>

      <!-- Color -->
      <div class="column-stack-sm">
        <label class="label-default">Color</label>
        <div class="input-border-full row-stack-none items-center justify-between select-field" (click)="openColorSelection()">
          <span [class.text-placeholder]="!color" class="body1-regular flex-1">
            {{ color || 'Select color' }}
          </span>
          <app-icon name="unfold-more" [size]="20" [color]="'var(--text-color-600)'"></app-icon>
        </div>
      </div>

      <!-- Climate Fit -->
      <div class="column-stack-sm">
        <label class="label-default">Climate fit</label>
        <div class="input-border-full row-stack-none items-center justify-between select-field" (click)="openClimateFitSelection()">
          <span [class.text-placeholder]="climateFit.length === 0" class="body1-regular flex-1">
            {{ climateFitDisplay || 'Select climate fit' }}
          </span>
          <app-icon name="unfold-more" [size]="20" [color]="'var(--text-color-600)'"></app-icon>
        </div>
      </div>

      <!-- Brand -->
      <div class="column-stack-sm">
        <label class="label-default">Brand</label>
        <div class="input-border-full">
          <input
            type="text"
            id="brand-input"
            [(ngModel)]="brand"
            placeholder="Name brand"
            class="body1-regular"
            (focus)="onBrandFieldFocus()"
            (blur)="onBrandFieldBlur()"
          />
        </div>
        <span class="text-color-600 body2-regular optional-text">Optional</span>
      </div>
    </div>

    <!-- Add Button -->
    <div class="button-container">
      <app-button
        variant="primary"
        size="xlarge"
        [fullWidth]="true"
        [disabled]="!isFormValid || isSubmitting"
        (click)="addToWardrobe()"
      >
        <span *ngIf="isSubmitting && !isEditMode" class="row-stack-sm items-center justify-center button-content">
          <span>Add to wardrobe</span>
          <ion-spinner name="lines" [color]="'light'" class="button-spinner"></ion-spinner>
        </span>
        <span *ngIf="!isSubmitting || isEditMode">
          {{ isEditMode ? 'Update wardrobe' : 'Add to wardrobe' }}
        </span>
      </app-button>
    </div>
  </div>
</ion-content>

