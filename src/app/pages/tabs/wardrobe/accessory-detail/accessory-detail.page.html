<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" >
        <app-icon name="arrow-left" [size]="24" [color]="'var(--ion-color-primary)'"></app-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="ion-text-center">{{ title }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" *ngIf="item">
  <div class="detail-container column-stack-md pad-all-md">
    <ion-toast
      [isOpen]="showSuccessMessage"
      [message]="successToastMessage"
      [duration]="5000"
      color="success"
      icon="checkmark-outline"
      position="top"
      cssClass="success-toast"
      (didDismiss)="onSuccessToastDismiss()"
    ></ion-toast>

    <!-- Garment Image -->
    <div class="image-container" 
         (touchstart)="onTouchStart($event)" 
         (touchend)="onTouchEnd($event)">
      <img [src]="currentImage" [alt]="item.subtype" class="garment-image" />

      <!-- Upload overlay when replacing image via autorenew -->
      <div *ngIf="isReplacingImage" class="replace-image-overlay">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <p class="replace-image-text body1-medium">Uploading image...</p>
      </div>

      <!-- Image actions: autorenew = replace image, delete = remove AI-enhanced image. Always visible when image is shown. -->
      <div class="image-actions" *ngIf="currentImage">
        <button
          type="button"
          class="image-action-button"
          *ngIf="showAutorenewIcon"
          (click)="onReplaceImage()"
        >
          <app-icon
            name="autorenew"
            [size]="24"
            [color]="'var(--ion-color-primary)'"
          ></app-icon>
        </button>
        <button
          type="button"
          class="image-action-button"
          *ngIf="showDeleteAiIcon"
          (click)="onDeleteAiImage()"
        >
          <app-icon
            name="delete-image"
            [size]="24"
            [color]="'var(--ion-color-primary)'"
          ></app-icon>
        </button>
      </div>

      <app-carousel-badge
        *ngIf="hasMultipleImages"
        [variant]="currentImageIndex === images.length - 1 ? 'original' : 'ai-enhanced'"
      ></app-carousel-badge>
      <!-- Pagination Dots - Overlay on bottom of image -->
      <div class="pagination-dots row-stack-xs items-center justify-center" *ngIf="hasMultipleImages">
        <span
          *ngFor="let image of images; let i = index"
          class="dot"
          [class.active]="i === currentImageIndex"
          (click)="goToImage(i)"
        ></span>
      </div>
    </div>

    <!-- AI Photo Upgrade Card -->
    <app-photo-upgrade-card (upgrade)="onAICleanup()"></app-photo-upgrade-card>

    <div class="use-outfit-button" *ngIf="linkedOutfits.length > 0">
      <app-button
        variant="primary"
        size="medium"
        [fullWidth]="false"
        (click)="onUseInOutfit()"
      >
        Use in outfit
        <app-icon name="add" [size]="20" [color]="'var(--ion-color-primary-contrast)'" class="mr-sm"></app-icon>
        
      </app-button>
    </div>

    <!-- Tabs -->
    <app-detail-tabs
      [tabs]="detailTabs"
      [activeTab]="activeTab"
      (tabChange)="setActiveTab($event)"
    ></app-detail-tabs>

    <!-- Outfits Tab -->
    <div *ngIf="activeTab === 'outfits'">
      <div *ngIf="isLoadingOutfits" class="loading-container">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
      </div>

      <app-empty-state
        *ngIf="!isLoadingOutfits && linkedOutfits.length === 0"
        [compact]="true"
        [disableColumnStackNone]="true"
        icon="accessibility"
        [iconSize]="72"
        iconColor="var(--red-extra-light-muted)"
        title="Not used in any outfits yet."
        description=""
        buttonText="Use garment in outfit"
        [showButton]="true"
        (onButtonClick)="onUseInOutfit()"
      ></app-empty-state>

      <div *ngIf="!isLoadingOutfits && linkedOutfits.length > 0" class="column-stack-md">
        <div class="row-stack-none items-center justify-between">
          <span class="body1-bold">Featured in {{ linkedOutfits.length }} outfits</span>
        </div>
        <div
          *ngFor="let outfit of linkedOutfits"
          class="outfit-item row-stack-none items-center justify-between"
          (click)="onOutfitClick(outfit)"
        >
          <div class="column-stack-xs">
            <span class="body1-medium">{{ outfit.name || 'Untitled Outfit' }}</span>
            <div class="row-stack-xs outfit-garments">
              <img
                *ngFor="let garment of getOutfitGarments(outfit) | slice:0:5"
                [src]="getGarmentImage(garment)"
                [alt]="garment.subtype || 'Garment'"
                class="outfit-garment-thumb"
              />
              <app-count-badge
                *ngIf="getOutfitGarments(outfit).length > 5"
                [count]="getOutfitGarments(outfit).length - 5"
                [size]="40"
              ></app-count-badge>
            </div>
          </div>
          <app-icon name="chevron-forward" [size]="20" [color]="'var(--ion-color-primary)'"></app-icon>
        </div>
      </div>
    </div>

    <!-- Details Tab -->
    <div *ngIf="activeTab === 'details'" class="form-fields column-stack-none">
      <div class="body1-bold">Garment details</div>
      <div class="column-stack-sm">
        <div class="input-border-full row-stack-none items-center justify-between select-field" (click)="onEditSubtype()">
          <span class="label-default">Subtype</span>
          <div class="row-stack-xs items-center">
            <span [class.text-placeholder]="!item.subtype" class="body1-regular value-text ion-text-end">
              {{ item.subtype || 'Select subtype' }}
            </span>
            <app-icon name="chevron-forward" [size]="20" [color]="'var(--text-color-600)'"></app-icon>
          </div>
        </div>
      </div>
      <div class="column-stack-sm">
        <div
          class="input-border-full row-stack-none items-center justify-between select-field color-field"
          [class.color-selected]="!!colorBackground"
          [style.backgroundColor]="colorBackground || null"
          [style.borderColor]="colorBackground || null"
          (click)="onEditColor()"
        >
          <span class="label-default" [style.color]="colorBackground ? colorTextColor : null">Color</span>
          <div class="row-stack-xs items-center">
            <span
              [class.text-placeholder]="!item.color"
              class="body1-regular value-text ion-text-end"
              [style.color]="colorBackground ? colorTextColor : null"
            >
              {{ item.color || 'Select color' }}
            </span>
            <app-icon name="chevron-forward" [size]="20" [color]="colorBackground ? colorTextColor : 'var(--text-color-600)'"></app-icon>
          </div>
        </div>
      </div>
      <div class="column-stack-sm">
        <div class="input-border-full row-stack-none items-center justify-between brand-field">
          <span class="label-default">Brand</span>
          <input
            #brandInput
            type="text"
            [(ngModel)]="brandDraft"
            placeholder="Name brand"
            class="body1-regular brand-input ion-text-end"
            enterkeyhint="done"
            (keydown.enter)="brandInput.blur(); dismissKeyboard()"
            (blur)="onBrandBlur(); dismissKeyboard()"
          />
        </div>
      </div>
      <div class="delete-container">
        <button class="delete-link body1-regular" (click)="onDelete()">
         Delete garment from wardrobe
        </button>
      </div>
    </div>
  </div>
</ion-content>





