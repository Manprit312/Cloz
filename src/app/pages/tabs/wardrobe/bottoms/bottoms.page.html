<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" >
        <app-icon name="arrow-left" [size]="24" [color]="'#1860FA'"></app-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="ion-text-center">Bottoms</ion-title>
</ion-toolbar>

</ion-header>

<ion-content [fullscreen]="true">
  <div class="pad-all-md">
    <!-- Subtype Filters - Only show when there are items -->
    <div class="subtype-filters row-stack-sm" *ngIf="!isLoading && !error && items.length > 0">
      <app-button
        *ngFor="let subtype of availableSubtypes"
        [variant]="selectedSubtype === subtype ? 'primary' : 'tertiary'"
        size="small"
        [fullWidth]="false"
        (click)="selectSubtype(subtype)"
        class="filter-button"
      >
        {{ subtype }}
      </app-button>
    </div>

    <!-- Show loading state -->
    <div *ngIf="isLoading" class="loading-container">
      <ion-grid class="items-grid">
        <ion-row>
          <ion-col size="4" *ngFor="let item of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]">
            <ion-item class="garment-item" lines="none">
              <ion-thumbnail slot="start" class="garment-thumbnail">
                <app-skeleton-loader type="image" [width]="'100%'" [height]="'100%'" [borderRadius]="'8px'" class="skeleton-square"></app-skeleton-loader>
              </ion-thumbnail>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- Show error state -->
    <div *ngIf="error && !isLoading" class="error-container">
      <p>{{ error }}</p>
      <app-button (click)="loadBottoms()" variant="primary" size="small">
        Retry
      </app-button>
    </div>

    <!-- Show empty state when no items (only when all items are loaded) -->
    <app-empty-state
      *ngIf="!isLoading && !error && items.length === 0"
      icon="hanger"
      [iconSize]="64"
      iconColor="var(--text-color-600, #666666)"
      title="No bottoms yet"
      description="Add your pants, skirts, or shorts to continue building your wardrobe."
      buttonText="Add item"
      [showButton]="true"
      (onButtonClick)="onAddItem()"
    ></app-empty-state>

    <!-- Show items grid when items exist -->
    <ion-grid *ngIf="!isLoading && !error && filteredItems.length > 0" class="items-grid">
      <ion-row>
        <ion-col
          *ngFor="let item of filteredItems"
          size="4"
        >
          <ion-item
            button
            (click)="onItemClick(item)"
            class="garment-item"
            lines="none"
          >
            <ion-thumbnail slot="start" class="garment-thumbnail">
              <!-- Skeleton loader while image is loading -->
              <app-skeleton-loader 
                *ngIf="!isImageLoaded(item)"
                type="image" 
                [width]="'100%'" 
                [height]="'150px'" 
                [borderRadius]="'8px'"
                class="image-skeleton"
              ></app-skeleton-loader>
              
              <!-- Carousel for multiple images -->
              <div 
                *ngIf="hasMultipleImages(item) && isImageLoaded(item)" 
                class="garment-carousel"
                (touchstart)="onTouchStart($event, item)"
                (touchend)="onTouchEnd($event, item)"
                (click)="$event.stopPropagation()"
              >
                <img 
                  [src]="getCurrentImage(item)" 
                  [alt]="item.subtype" 
                  class="garment-image"
                  loading="lazy"
                  (load)="onImageLoad(item)"
                />
                <!-- Pagination dots -->
                <div class="carousel-dots row-stack-xs">
                  <span
                    *ngFor="let img of getImages(item); let i = index"
                    class="dot"
                    [class.active]="i === getCurrentImageIndex(item)"
                  ></span>
                </div>
              </div>
              <!-- Single image -->
              <img 
                *ngIf="!hasMultipleImages(item) && isImageLoaded(item)"
                [src]="item.imageUrl" 
                [alt]="item.subtype" 
                class="garment-image"
                loading="lazy"
                (load)="onImageLoad(item)"
              />
              <!-- Hidden image to trigger load event for carousel -->
              <img 
                *ngIf="hasMultipleImages(item) && !isImageLoaded(item)"
                [src]="getCurrentImage(item)" 
                [alt]="item.subtype" 
                style="display: none;"
                (load)="onImageLoad(item)"
              />
              <!-- Hidden image to trigger load event for single image -->
              <img 
                *ngIf="!hasMultipleImages(item) && !isImageLoaded(item)"
                [src]="item.imageUrl" 
                [alt]="item.subtype" 
                style="display: none;"
                (load)="onImageLoad(item)"
              />
            </ion-thumbnail>
          </ion-item>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <!-- Floating Action Button - Only show when there are items -->
  <ion-fab 
    *ngIf="!isLoading && !error && items.length > 0"
    vertical="bottom" 
    horizontal="end" 
    slot="fixed"
  >
    <ion-fab-button (click)="onAddItem()">
      <app-icon name="add" [size]="24" [color]="'#ffffff'"></app-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
