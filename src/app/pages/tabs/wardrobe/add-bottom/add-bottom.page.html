<ion-backdrop *ngIf="isModalOpen" [visible]="true" [tappable]="false"></ion-backdrop>

<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-title class="ion-text-center">{{ isEditMode ? 'Update bottom' : 'Add bottom' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="close()" fill="clear" class="body1-regular">
        Close
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content #content [fullscreen]="true" class="add-garment-content">
  <div class="pad-top-lg pad-v-none-h-md add-garment-wrapper">
    <!-- Error Banner -->
    <div class="row-stack-sm items-center error-banner pad-all-md" *ngIf="showErrorMessage">
      <app-icon name="close" [size]="24" [color]="'var(--ion-color-primary-contrast)'"></app-icon>
      <span class="body1-medium">{{ errorMessageText }}</span>
    </div>

    <!-- Image Upload Section -->
    <div class="column-stack-sm image-section">
      <label class="label-default">Choose image</label>
      <div class="column-stack-md items-center image-upload-container">
        <input
          type="file"
          accept="image/*"
          (change)="onImageSelected($event)"
          class="file-input"
          id="image-upload-input"
        />
        <div class="column-stack-none items-center justify-center image-upload-area" (click)="selectImageSource()">
          <!-- Compression Loading Overlay -->
          <div *ngIf="isCompressing" class="column-stack-none items-center justify-center w-full h-full compression-overlay">
            <ion-spinner name="crescent" color="primary"></ion-spinner>
            <p class="compression-text body1-medium">Compressing image...</p>
          </div>
          
          <!-- Success Indicator -->
          <div *ngIf="compressionSuccess && !isCompressing" class="row-stack-xs items-center compression-success">
            <app-icon name="checkmark-circle" [size]="24" [color]="'var(--ion-color-success, #4CAF50)'"></app-icon>
            <p class="success-text body2-medium">Image optimized!</p>
          </div>
          
          <div *ngIf="!imageUrl && !isCompressing" class="column-stack-md items-center justify-center w-full h-full image-placeholder-container">
            <div class="items-center justify-center image-placeholder">
              <app-icon name="image" [size]="48" [color]="'var(--text-color-600)'"></app-icon>
            </div>
            <app-button
              variant="primary"
              size="medium"
              [fullWidth]="false"
              (click)="selectImageSource(); $event.stopPropagation()"
              class="upload-button-inside"
            >
              Upload garment image
              <app-icon name="add" [size]="20" [color]="'var(--ion-color-primary-contrast)'" class="ml-sm"></app-icon>
            </app-button>
          </div>
          <div *ngIf="imageUrl && !isCompressing" class="column-stack-none items-center justify-center w-full h-full image-with-button">
            <img [src]="imageUrl" alt="Garment" class="garment-image" />
            <app-button
              variant="tertiary"
              size="medium"
              [fullWidth]="false"
              (click)="selectImageSource(); $event.stopPropagation()"
              class="replace-button-inside"
            >
              <app-icon name="refresh" [size]="20" [color]="'var(--ion-color-primary)'" class="mr-sm"></app-icon>
              Replace
            </app-button>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Fields -->
    <div class="column-stack-lg">
      <!-- Subtype -->
      <div class="column-stack-sm">
        <div class="input-border-full row-stack-none items-center justify-between select-field" (click)="openSubtypeSelection()">
          <span class="label-default">Subtype</span>
          <div class="row-stack-xs items-center">
            <span [class.text-placeholder]="!subtype" class="body1-regular value-text ion-text-end">
              {{ subtype || 'Select subtype' }}
            </span>
            <app-icon name="chevron-forward" [size]="20" [color]="'var(--text-color-600)'"></app-icon>
          </div>
        </div>
      </div>

      <!-- Color -->
      <div class="column-stack-sm">
        <div
          class="input-border-full row-stack-none items-center justify-between select-field color-field"
          [class.color-selected]="!!colorBackground"
          [style.backgroundColor]="colorBackground || null"
          [style.borderColor]="colorBackground || null"
          (click)="openColorSelection()"
        >
          <span class="label-default" [style.color]="color ? colorTextColor : null">Color</span>
          <div class="row-stack-xs items-center">
            <span
              [class.text-placeholder]="!color"
              class="body1-regular value-text ion-text-end"
              [style.color]="color ? colorTextColor : null"
            >
              {{ color || 'Select color' }}
            </span>
            <app-icon
              name="chevron-forward"
              [size]="20"
              [color]="color ? colorTextColor : 'var(--text-color-600)'"
            ></app-icon>
          </div>
        </div>
      </div>

      <!-- Brand -->
      <div class="column-stack-sm">
        <label class="label-default">Brand</label>
        <div class="input-border-full">
          <input
            #brandInput
            type="text"
            [(ngModel)]="brand"
            placeholder="Name brand"
            class="body1-regular"
            enterkeyhint="done"
            (keydown.enter)="brandInput.blur(); dismissKeyboard()"
            (blur)="dismissKeyboard()"
          />
        </div>
        <span class="text-color-600 body2-regular optional-text">Optional</span>
      </div>
    </div>

    <!-- Add Button -->
    <div class="button-container">
      <app-button
        variant="primary"
        size="xlarge"
        [fullWidth]="true"
        [disabled]="!isFormValid || isSubmitting"
        (click)="addToWardrobe()"
      >
        <span *ngIf="isSubmitting && !isEditMode" class="row-stack-sm items-center justify-center button-content">
          <span>Add to wardrobe</span>
          <ion-spinner name="lines" [color]="'light'" class="button-spinner"></ion-spinner>
        </span>
        <span *ngIf="!isSubmitting || isEditMode">
          {{ isEditMode ? 'Update wardrobe' : 'Add to wardrobe' }}
        </span>
      </app-button>
    </div>
  </div>
</ion-content>

